<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!--Description-->
    
        <meta name="description" content="Trying to be the person you want to be.">
    

    <!--Author-->
    
        <meta name="author" content="TIGERB">
    

    <!--Open Graph Title-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="TIGERB"/>

    <!--Page Cover-->
    
        <meta property="og:image" content="undefined"/>
    

    <!-- Title -->
    
    <title>TIGERB</title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/sass/main.css">

    <!--[if lt IE 8]>
        <script src="/js/ie/html5shiv.js"></script>
    <![endif]-->

    <!--[if lt IE 8]>
        <link rel="stylesheet" href="/sass/ie8.css">
    <![endif]-->

    <!--[if lt IE 9]>
        <link rel="stylesheet" href="/sass/ie9.css">
    <![endif]-->

    <!-- Gallery -->
    <link href="https://cdn.bootcss.com/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    


    <script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?30c7e7d53256334a8dc1cf524fcc77f6";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
    })();
    </script>

</head>

<body>

    <div id="wrapper">

        <!-- Menu -->
        <!-- Header -->
<header id="header">
    <div class="inner">

        <!-- Logo -->
        <a href="/" class="logo">
            <span class="symbol"><img src="http://cdn.tigerb.cn/20190707142019.png" alt="" /></span><span class="title">TIGERB</span>
        </a>

        <!-- Nav -->
        <nav>
            <ul>
                <li><a href="#menu">Menu</a></li>
            </ul>
        </nav>

    </div>
</header>

<!-- Menu -->
<nav id="menu">
    <h2>Menu</h2>
    <ul>
        
            <li>
                <a href="/">首页</a>
            </li>
        
            <li>
                <a href="https://github.com/TIGERB">Github</a>
            </li>
        
            <li>
                <a href="https://segmentfault.com/u/tigerb">Segmentfault</a>
            </li>
        
            <li>
                <a href="https://juejin.im/user/5855e82d1b69e6006c9278b4">掘金</a>
            </li>
        
    </ul>
</nav>


        <div id="main">
            <div class="inner">

                <!-- Main Content -->
                

    <h1 class="title">No Code No Life</h1>
    <div class="meta">
        2021-01-08
    </div>


<span class="image main"><img src="No Code No Life" alt="" /></span>


<!-- Gallery -->


<!-- Content -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css"><div class=".article-gallery" <h2="" id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言<p>本系列主要分享，如何在我们的真实业务场景中使用设计模式。</p>
<p>本系列文章主要采用如下结构：</p>
<ul>
<li>什么是「XX设计模式」？</li>
<li>什么真实业务场景可以使用「XX设计模式」？</li>
<li>怎么用「XX设计模式」？</li>
</ul>
<h2 id="什么是「模板模式」？"><a href="#什么是「模板模式」？" class="headerlink" title="什么是「模板模式」？"></a>什么是「模板模式」？</h2><p>抽象类里定义好<strong>算法的执行步骤</strong>和<strong>具体算法</strong>，以及可能发生变化的算法定义为<strong>抽象方法</strong>。不同的子类继承该抽象类，并实现父类的抽象方法。</p>
<p>模板模式的优势：</p>
<ul>
<li>不变的算法被继承复用：不变的部分高度封装、复用。</li>
<li>变化的算法子类继承并具体实现：变化的部分子类只需要具体实现抽象的部分即可，方便扩展，且可无限扩展。</li>
</ul>
<h2 id="什么真实业务场景可以用「模板模式」？"><a href="#什么真实业务场景可以用「模板模式」？" class="headerlink" title="什么真实业务场景可以用「模板模式」？"></a>什么真实业务场景可以用「模板模式」？</h2><p>满足如下要求的所有场景:</p>
<blockquote>
<p>算法执行的步骤是稳定<strong>不变的</strong>，但是具体的某些算法可能存在<strong>变</strong>化的场景。</p>
</blockquote>
<p>怎么理解，举个例子：<code>比如说你煮个面，必然需要先烧水，水烧开之后再放面进去</code>，以上的流程我们称之为<code>煮面过程</code>。可知：这个<code>煮面过程</code>的步骤是稳定不变的，但是在不同的环境烧水的方式可能不尽相同，也许有的人用天然气烧水、有的人用电磁炉烧水、有的人用柴火烧水，等等。我们可以得到以下结论：</p>
<ul>
<li><code>煮面过程</code>的步骤是稳定不变的</li>
<li><code>煮面过程</code>的烧水方式是可变的</li>
</ul>
<blockquote>
<p>我们有哪些真实业务场景可以用「模板模式」呢？</p>
</blockquote>
<p>比如抽奖系统的抽奖接口，为什么：</p>
<ul>
<li>抽奖的步骤是稳定不变的 -&gt; <strong>不变的</strong>算法执行步骤</li>
<li>不同抽奖类型活动在某些逻辑处理方式可能不同 -&gt; <strong>变的</strong>某些算法</li>
</ul>
<h2 id="怎么用「模板模式」？"><a href="#怎么用「模板模式」？" class="headerlink" title="怎么用「模板模式」？"></a>怎么用「模板模式」？</h2><p>关于怎么用，完全可以生搬硬套我总结的使用设计模式的四个步骤：</p>
<ul>
<li>业务梳理</li>
<li>业务流程图</li>
<li>代码建模</li>
<li>代码demo</li>
</ul>
<h4 id="业务梳理"><a href="#业务梳理" class="headerlink" title="业务梳理"></a>业务梳理</h4><p>我通过历史上接触过的各种抽奖场景（红包雨、糖果雨、打地鼠、大转盘(九宫格)、考眼力、答题闯关、游戏闯关、支付刮刮乐、积分刮刮乐等等），按照真实业务需求梳理了以下抽奖业务抽奖接口的大致文本流程。</p>
<p>了解具体业务请点击<a href="http://tigerb.cn/2019/12/23/skr-lottery/">《通用抽奖工具之需求分析 | SkrShop》</a></p>
<table>
<thead>
<tr>
<th>主步骤</th>
<th>主逻辑</th>
<th>抽奖类型</th>
<th>子步骤</th>
<th>子逻辑</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>校验活动编号(serial_no)是否存在、并获取活动信息</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>2</td>
<td>校验活动、场次是否正在进行</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>3</td>
<td>其他参数校验(<strong>不同活动类型实现不同</strong>)</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>4</td>
<td>活动抽奖次数校验(同时扣减)</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>5</td>
<td>活动是否需要消费积分</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>6</td>
<td>场次抽奖次数校验(同时扣减)</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>7</td>
<td>获取场次奖品信息</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>8</td>
<td>获取node奖品信息(<strong>不同活动类型实现不同</strong>)</td>
<td><strong>按时间抽奖类型</strong></td>
<td>1</td>
<td>do nothing(抽取该场次的奖品即可，无需其他逻辑)</td>
</tr>
<tr>
<td>8</td>
<td></td>
<td><strong>按抽奖次数抽奖类型</strong></td>
<td>1</td>
<td>判断是该用户第几次抽奖</td>
</tr>
<tr>
<td>8</td>
<td></td>
<td></td>
<td>2</td>
<td>获取对应node的奖品信息</td>
</tr>
<tr>
<td>8</td>
<td></td>
<td></td>
<td>3</td>
<td>复写原所有奖品信息(抽取该node节点的奖品)</td>
</tr>
<tr>
<td>8</td>
<td></td>
<td><strong>按数额范围区间抽奖</strong></td>
<td>1</td>
<td>判断属于哪个数额区间</td>
</tr>
<tr>
<td>8</td>
<td></td>
<td></td>
<td>2</td>
<td>获取对应node的奖品信息</td>
</tr>
<tr>
<td>8</td>
<td></td>
<td></td>
<td>3</td>
<td>复写原所有奖品信息(抽取该node节点的奖品)</td>
</tr>
<tr>
<td>9</td>
<td>抽奖</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>10</td>
<td>奖品数量判断</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>11</td>
<td>组装奖品信息</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
<blockquote>
<p>注：流程不一定完全准确</p>
</blockquote>
<p>结论：</p>
<ul>
<li><code>主逻辑</code>是稳定不变的</li>
<li><code>其他参数校验</code>和<code>获取node奖品信息</code>的算法是可变的</li>
</ul>
<h4 id="业务流程图"><a href="#业务流程图" class="headerlink" title="业务流程图"></a>业务流程图</h4><p>我们通过梳理的文本业务流程得到了如下的业务流程图：</p>
<p><a href="http://cdn.tigerb.cn/20200325205347.png" class="gallery-item" target="_blank" rel="noopener"><img src="http://cdn.tigerb.cn/20200325205347.png" alt=""></a></p>
<h4 id="代码建模"><a href="#代码建模" class="headerlink" title="代码建模"></a>代码建模</h4><p>通过上面的分析我们可以得到：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">一个抽象类</span><br><span class="line">- 具体共有方法`Run`，里面定义了算法的执行步骤</span><br><span class="line">- 具体私有方法，不会发生变化的具体方法</span><br><span class="line">- 抽象方法，会发生变化的方法</span><br><span class="line"></span><br><span class="line">子类一(按时间抽奖类型)</span><br><span class="line">- 继承抽象类父类</span><br><span class="line">- 实现抽象方法</span><br><span class="line"></span><br><span class="line">子类二(按抽奖次数抽奖类型)</span><br><span class="line">- 继承抽象类父类</span><br><span class="line">- 实现抽象方法</span><br><span class="line"></span><br><span class="line">子类三(按数额范围区间抽奖)</span><br><span class="line">- 继承抽象类父类</span><br><span class="line">- 实现抽象方法</span><br></pre></td></tr></table></figure>
<p>但是golang里面没有继承的概念，我们就把对抽象类里抽象方法的依赖转化成对接口<code>interface</code>里抽象方法的依赖，同时也可以利用<code>合成复用</code>的方式“继承”模板:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">抽象行为的接口`BehaviorInterface`(包含如下需要实现的方法)</span><br><span class="line">- 其他参数校验的方法`checkParams`</span><br><span class="line">- 获取node奖品信息的方法`getPrizesByNode`</span><br><span class="line"></span><br><span class="line">抽奖结构体类</span><br><span class="line">- 具体共有方法`Run`，里面定义了算法的执行步骤</span><br><span class="line">- 具体私有方法`checkParams` 里面的逻辑实际依赖的接口BehaviorInterface.checkParams(ctx)的抽象方法</span><br><span class="line">- 具体私有方法`getPrizesByNode` 里面的逻辑实际依赖的接口BehaviorInterface.getPrizesByNode(ctx)的抽象方法</span><br><span class="line">- 其他具体私有方法，不会发生变化的具体方法</span><br><span class="line"></span><br><span class="line">实现`BehaviorInterface`的结构体一(按时间抽奖类型)</span><br><span class="line">- 实现接口方法</span><br><span class="line"></span><br><span class="line">实现`BehaviorInterface`的结构体二(按抽奖次数抽奖类型)</span><br><span class="line">- 实现接口方法</span><br><span class="line"></span><br><span class="line">实现`BehaviorInterface`的结构体三(按数额范围区间抽奖)</span><br><span class="line">- 实现接口方法</span><br></pre></td></tr></table></figure>
<p>同时得到了我们的UML图：</p>
<p><a href="http://cdn.tigerb.cn/20200326201327.jpg" class="gallery-item" target="_blank" rel="noopener"><img src="http://cdn.tigerb.cn/20200326201327.jpg" alt=""></a></p>
<h4 id="代码demo"><a href="#代码demo" class="headerlink" title="代码demo"></a>代码demo</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Go设计模式实战系列</span></span><br><span class="line"><span class="comment">//模板模式</span></span><br><span class="line"><span class="comment">//@auhtor TIGERB&lt;https://github.com/TIGERB&gt;</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	<span class="comment">// ConstActTypeTime 按时间抽奖类型</span></span><br><span class="line">	ConstActTypeTime <span class="keyword">int32</span> = <span class="number">1</span></span><br><span class="line">	<span class="comment">// ConstActTypeTimes 按抽奖次数抽奖</span></span><br><span class="line">	ConstActTypeTimes <span class="keyword">int32</span> = <span class="number">2</span></span><br><span class="line">	<span class="comment">// ConstActTypeAmount 按数额范围区间抽奖</span></span><br><span class="line">	ConstActTypeAmount <span class="keyword">int32</span> = <span class="number">3</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Context 上下文</span></span><br><span class="line"><span class="keyword">type</span> Context <span class="keyword">struct</span> &#123;</span><br><span class="line">	ActInfo *ActInfo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ActInfo 上下文</span></span><br><span class="line"><span class="keyword">type</span> ActInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 活动抽奖类型1: 按时间抽奖 2: 按抽奖次数抽奖 3:按数额范围区间抽奖</span></span><br><span class="line">	ActivityType <span class="keyword">int32</span></span><br><span class="line">	<span class="comment">// 其他字段略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BehaviorInterface 不同抽奖类型的行为差异的抽象接口</span></span><br><span class="line"><span class="keyword">type</span> BehaviorInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// 其他参数校验(不同活动类型实现不同)</span></span><br><span class="line">	checkParams(ctx *Context) error</span><br><span class="line">	<span class="comment">// 获取node奖品信息(不同活动类型实现不同)</span></span><br><span class="line">	getPrizesByNode(ctx *Context) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TimeDraw 具体抽奖行为</span></span><br><span class="line"><span class="comment">// 按时间抽奖类型 比如红包雨</span></span><br><span class="line"><span class="keyword">type</span> TimeDraw <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkParams 其他参数校验(不同活动类型实现不同)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(draw TimeDraw)</span> <span class="title">checkParams</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"按时间抽奖类型:特殊参数校验..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getPrizesByNode 获取node奖品信息(不同活动类型实现不同)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(draw TimeDraw)</span> <span class="title">getPrizesByNode</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"do nothing(抽取该场次的奖品即可，无需其他逻辑)..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TimesDraw 具体抽奖行为</span></span><br><span class="line"><span class="comment">// 按抽奖次数抽奖类型 比如答题闯关</span></span><br><span class="line"><span class="keyword">type</span> TimesDraw <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkParams 其他参数校验(不同活动类型实现不同)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(draw TimesDraw)</span> <span class="title">checkParams</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"按抽奖次数抽奖类型:特殊参数校验..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getPrizesByNode 获取node奖品信息(不同活动类型实现不同)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(draw TimesDraw)</span> <span class="title">getPrizesByNode</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"1. 判断是该用户第几次抽奖..."</span>)</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"2. 获取对应node的奖品信息..."</span>)</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"3. 复写原所有奖品信息(抽取该node节点的奖品)..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AmountDraw 具体抽奖行为</span></span><br><span class="line"><span class="comment">// 按数额范围区间抽奖 比如订单金额刮奖</span></span><br><span class="line"><span class="keyword">type</span> AmountDraw <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkParams 其他参数校验(不同活动类型实现不同)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(draw *AmountDraw)</span> <span class="title">checkParams</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"按数额范围区间抽奖:特殊参数校验..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getPrizesByNode 获取node奖品信息(不同活动类型实现不同)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(draw *AmountDraw)</span> <span class="title">getPrizesByNode</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"1. 判断属于哪个数额区间..."</span>)</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"2. 获取对应node的奖品信息..."</span>)</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"3. 复写原所有奖品信息(抽取该node节点的奖品)..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Lottery 抽奖模板</span></span><br><span class="line"><span class="keyword">type</span> Lottery <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 不同抽奖类型的抽象行为</span></span><br><span class="line">	concreteBehavior BehaviorInterface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run 抽奖算法</span></span><br><span class="line"><span class="comment">// 稳定不变的算法步骤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">Run</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 具体方法：校验活动编号(serial_no)是否存在、并获取活动信息</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.checkSerialNo(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：校验活动、场次是否正在进行</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.checkStatus(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ”抽象方法“：其他参数校验</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.checkParams(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：活动抽奖次数校验(同时扣减)</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.checkTimesByAct(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：活动是否需要消费积分</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.consumePointsByAct(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：场次抽奖次数校验(同时扣减)</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.checkTimesBySession(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：获取场次奖品信息</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.getPrizesBySession(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ”抽象方法“：获取node奖品信息</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.getPrizesByNode(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：抽奖</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.drawPrizes(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：奖品数量判断</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.checkPrizesStock(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：组装奖品信息</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.packagePrizeInfo(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkSerialNo 校验活动编号(serial_no)是否存在</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">checkSerialNo</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"校验活动编号(serial_no)是否存在、并获取活动信息..."</span>)</span><br><span class="line">	<span class="comment">// 获取活动信息伪代码</span></span><br><span class="line">	ctx.ActInfo = &amp;ActInfo&#123;</span><br><span class="line">	<span class="comment">// 假设当前的活动类型为按抽奖次数抽奖</span></span><br><span class="line">	ActivityType: ConstActTypeTimes,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取当前抽奖类型的具体行为</span></span><br><span class="line">	<span class="keyword">switch</span> ctx.ActInfo.ActivityType &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">	<span class="comment">// 按时间抽奖</span></span><br><span class="line">	lottery.concreteBehavior = &amp;TimeDraw&#123;&#125;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">	<span class="comment">// 按抽奖次数抽奖</span></span><br><span class="line">	lottery.concreteBehavior = &amp;TimesDraw&#123;&#125;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">	<span class="comment">// 按数额范围区间抽奖</span></span><br><span class="line">	lottery.concreteBehavior = &amp;AmountDraw&#123;&#125;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">	<span class="keyword">return</span> fmt.Errorf(<span class="string">"不存在的活动类型"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkStatus 校验活动、场次是否正在进行</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">checkStatus</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"校验活动、场次是否正在进行..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkParams 其他参数校验(不同活动类型实现不同)</span></span><br><span class="line"><span class="comment">// 不同场景变化的算法 转化为依赖抽象</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">checkParams</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 实际依赖的接口的抽象方法</span></span><br><span class="line">	<span class="keyword">return</span> lottery.concreteBehavior.checkParams(ctx)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkTimesByAct 活动抽奖次数校验</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">checkTimesByAct</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"活动抽奖次数校验..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// consumePointsByAct 活动是否需要消费积分</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">consumePointsByAct</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"活动是否需要消费积分..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkTimesBySession 活动抽奖次数校验</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">checkTimesBySession</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"活动抽奖次数校验..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getPrizesBySession 获取场次奖品信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">getPrizesBySession</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"获取场次奖品信息..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getPrizesByNode 获取node奖品信息(不同活动类型实现不同)</span></span><br><span class="line"><span class="comment">// 不同场景变化的算法 转化为依赖抽象</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">getPrizesByNode</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 实际依赖的接口的抽象方法</span></span><br><span class="line">	<span class="keyword">return</span> lottery.concreteBehavior.getPrizesByNode(ctx)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// drawPrizes 抽奖</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">drawPrizes</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"抽奖..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkPrizesStock 奖品数量判断</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">checkPrizesStock</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"奖品数量判断..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packagePrizeInfo 组装奖品信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">packagePrizeInfo</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"组装奖品信息..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	(&amp;Lottery&#123;&#125;).Run(&amp;Context&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取正在运行的函数名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runFuncName</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	pc := <span class="built_in">make</span>([]<span class="keyword">uintptr</span>, <span class="number">1</span>)</span><br><span class="line">	runtime.Callers(<span class="number">2</span>, pc)</span><br><span class="line">	f := runtime.FuncForPC(pc[<span class="number">0</span>])</span><br><span class="line">	<span class="keyword">return</span> f.Name()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下是代码执行结果:<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[Running] go run &quot;.../easy-tips/go/src/patterns/template/template.go&quot;</span><br><span class="line">main.(*Lottery).checkSerialNo 校验活动编号(serial_no)是否存在、并获取活动信息...</span><br><span class="line">main.(*Lottery).checkStatus 校验活动、场次是否正在进行...</span><br><span class="line">main.TimesDraw.checkParams 按抽奖次数抽奖类型:特殊参数校验...</span><br><span class="line">main.(*Lottery).checkTimesByAct 活动抽奖次数校验...</span><br><span class="line">main.(*Lottery).consumePointsByAct 活动是否需要消费积分...</span><br><span class="line">main.(*Lottery).checkTimesBySession 活动抽奖次数校验...</span><br><span class="line">main.(*Lottery).getPrizesBySession 获取场次奖品信息...</span><br><span class="line">main.TimesDraw.getPrizesByNode 1. 判断是该用户第几次抽奖...</span><br><span class="line">main.TimesDraw.getPrizesByNode 2. 获取对应node的奖品信息...</span><br><span class="line">main.TimesDraw.getPrizesByNode 3. 复写原所有奖品信息(抽取该node节点的奖品)...</span><br><span class="line">main.(*Lottery).drawPrizes 抽奖...</span><br><span class="line">main.(*Lottery).checkPrizesStock 奖品数量判断...</span><br><span class="line">main.(*Lottery).packagePrizeInfo 组装奖品信息...</span><br></pre></td></tr></table></figure></p>
<p>demo代码地址：<a href="https://github.com/TIGERB/easy-tips/blob/master/go/src/patterns/template/template.go" target="_blank" rel="noopener">https://github.com/TIGERB/easy-tips/blob/master/go/src/patterns/template/template.go</a></p>
<h4 id="代码demo2-利用golang的合成复用特性实现"><a href="#代码demo2-利用golang的合成复用特性实现" class="headerlink" title="代码demo2(利用golang的合成复用特性实现)"></a>代码demo2(利用golang的<code>合成复用</code>特性实现)</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Go设计模式实战系列</span></span><br><span class="line"><span class="comment">//模板模式</span></span><br><span class="line"><span class="comment">//@auhtor TIGERB&lt;https://github.com/TIGERB&gt;</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	<span class="comment">// ConstActTypeTime 按时间抽奖类型</span></span><br><span class="line">	ConstActTypeTime <span class="keyword">int32</span> = <span class="number">1</span></span><br><span class="line">	<span class="comment">// ConstActTypeTimes 按抽奖次数抽奖</span></span><br><span class="line">	ConstActTypeTimes <span class="keyword">int32</span> = <span class="number">2</span></span><br><span class="line">	<span class="comment">// ConstActTypeAmount 按数额范围区间抽奖</span></span><br><span class="line">	ConstActTypeAmount <span class="keyword">int32</span> = <span class="number">3</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Context 上下文</span></span><br><span class="line"><span class="keyword">type</span> Context <span class="keyword">struct</span> &#123;</span><br><span class="line">	ActInfo *ActInfo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ActInfo 上下文</span></span><br><span class="line"><span class="keyword">type</span> ActInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 活动抽奖类型1: 按时间抽奖 2: 按抽奖次数抽奖 3:按数额范围区间抽奖</span></span><br><span class="line">	ActivityType <span class="keyword">int32</span></span><br><span class="line">	<span class="comment">// 其他字段略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BehaviorInterface 不同抽奖类型的行为差异的抽象接口</span></span><br><span class="line"><span class="keyword">type</span> BehaviorInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// 其他参数校验(不同活动类型实现不同)</span></span><br><span class="line">	checkParams(ctx *Context) error</span><br><span class="line">	<span class="comment">// 获取node奖品信息(不同活动类型实现不同)</span></span><br><span class="line">	getPrizesByNode(ctx *Context) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TimeDraw 具体抽奖行为</span></span><br><span class="line"><span class="comment">// 按时间抽奖类型 比如红包雨</span></span><br><span class="line"><span class="keyword">type</span> TimeDraw <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 合成复用模板</span></span><br><span class="line">	Lottery</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkParams 其他参数校验(不同活动类型实现不同)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(draw TimeDraw)</span> <span class="title">checkParams</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"按时间抽奖类型:特殊参数校验..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getPrizesByNode 获取node奖品信息(不同活动类型实现不同)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(draw TimeDraw)</span> <span class="title">getPrizesByNode</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"do nothing(抽取该场次的奖品即可，无需其他逻辑)..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TimesDraw 具体抽奖行为</span></span><br><span class="line"><span class="comment">// 按抽奖次数抽奖类型 比如答题闯关</span></span><br><span class="line"><span class="keyword">type</span> TimesDraw <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 合成复用模板</span></span><br><span class="line">	Lottery</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkParams 其他参数校验(不同活动类型实现不同)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(draw TimesDraw)</span> <span class="title">checkParams</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"按抽奖次数抽奖类型:特殊参数校验..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getPrizesByNode 获取node奖品信息(不同活动类型实现不同)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(draw TimesDraw)</span> <span class="title">getPrizesByNode</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"1. 判断是该用户第几次抽奖..."</span>)</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"2. 获取对应node的奖品信息..."</span>)</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"3. 复写原所有奖品信息(抽取该node节点的奖品)..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AmountDraw 具体抽奖行为</span></span><br><span class="line"><span class="comment">// 按数额范围区间抽奖 比如订单金额刮奖</span></span><br><span class="line"><span class="keyword">type</span> AmountDraw <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 合成复用模板</span></span><br><span class="line">	Lottery</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkParams 其他参数校验(不同活动类型实现不同)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(draw *AmountDraw)</span> <span class="title">checkParams</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"按数额范围区间抽奖:特殊参数校验..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getPrizesByNode 获取node奖品信息(不同活动类型实现不同)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(draw *AmountDraw)</span> <span class="title">getPrizesByNode</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"1. 判断属于哪个数额区间..."</span>)</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"2. 获取对应node的奖品信息..."</span>)</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"3. 复写原所有奖品信息(抽取该node节点的奖品)..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Lottery 抽奖模板</span></span><br><span class="line"><span class="keyword">type</span> Lottery <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 不同抽奖类型的抽象行为</span></span><br><span class="line">	ConcreteBehavior BehaviorInterface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run 抽奖算法</span></span><br><span class="line"><span class="comment">// 稳定不变的算法步骤</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">Run</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 具体方法：校验活动编号(serial_no)是否存在、并获取活动信息</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.checkSerialNo(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：校验活动、场次是否正在进行</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.checkStatus(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ”抽象方法“：其他参数校验</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.checkParams(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：活动抽奖次数校验(同时扣减)</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.checkTimesByAct(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：活动是否需要消费积分</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.consumePointsByAct(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：场次抽奖次数校验(同时扣减)</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.checkTimesBySession(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：获取场次奖品信息</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.getPrizesBySession(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ”抽象方法“：获取node奖品信息</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.getPrizesByNode(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：抽奖</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.drawPrizes(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：奖品数量判断</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.checkPrizesStock(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 具体方法：组装奖品信息</span></span><br><span class="line">	<span class="keyword">if</span> err = lottery.packagePrizeInfo(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkSerialNo 校验活动编号(serial_no)是否存在</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">checkSerialNo</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"校验活动编号(serial_no)是否存在、并获取活动信息..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkStatus 校验活动、场次是否正在进行</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">checkStatus</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"校验活动、场次是否正在进行..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkParams 其他参数校验(不同活动类型实现不同)</span></span><br><span class="line"><span class="comment">// 不同场景变化的算法 转化为依赖抽象</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">checkParams</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 实际依赖的接口的抽象方法</span></span><br><span class="line">	<span class="keyword">return</span> lottery.ConcreteBehavior.checkParams(ctx)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkTimesByAct 活动抽奖次数校验</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">checkTimesByAct</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"活动抽奖次数校验..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// consumePointsByAct 活动是否需要消费积分</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">consumePointsByAct</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"活动是否需要消费积分..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkTimesBySession 活动抽奖次数校验</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">checkTimesBySession</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"活动抽奖次数校验..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getPrizesBySession 获取场次奖品信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">getPrizesBySession</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"获取场次奖品信息..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getPrizesByNode 获取node奖品信息(不同活动类型实现不同)</span></span><br><span class="line"><span class="comment">// 不同场景变化的算法 转化为依赖抽象</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">getPrizesByNode</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 实际依赖的接口的抽象方法</span></span><br><span class="line">	<span class="keyword">return</span> lottery.ConcreteBehavior.getPrizesByNode(ctx)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// drawPrizes 抽奖</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">drawPrizes</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"抽奖..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkPrizesStock 奖品数量判断</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">checkPrizesStock</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"奖品数量判断..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// packagePrizeInfo 组装奖品信息</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(lottery *Lottery)</span> <span class="title">packagePrizeInfo</span><span class="params">(ctx *Context)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"组装奖品信息..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ctx := &amp;Context&#123;</span><br><span class="line">	ActInfo: &amp;ActInfo&#123;</span><br><span class="line">	ActivityType: ConstActTypeAmount,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> ctx.ActInfo.ActivityType &#123;</span><br><span class="line">	<span class="keyword">case</span> ConstActTypeTime: <span class="comment">// 按时间抽奖类型</span></span><br><span class="line">	instance := &amp;TimeDraw&#123;&#125;</span><br><span class="line">	instance.ConcreteBehavior = instance</span><br><span class="line">	instance.Run(ctx)</span><br><span class="line">	<span class="keyword">case</span> ConstActTypeTimes: <span class="comment">// 按抽奖次数抽奖</span></span><br><span class="line">	instance := &amp;TimesDraw&#123;&#125;</span><br><span class="line">	instance.ConcreteBehavior = instance</span><br><span class="line">	instance.Run(ctx)</span><br><span class="line">	<span class="keyword">case</span> ConstActTypeAmount: <span class="comment">// 按数额范围区间抽奖</span></span><br><span class="line">	instance := &amp;AmountDraw&#123;&#125;</span><br><span class="line">	instance.ConcreteBehavior = instance</span><br><span class="line">	instance.Run(ctx)</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">	<span class="comment">// 报错</span></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取正在运行的函数名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runFuncName</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	pc := <span class="built_in">make</span>([]<span class="keyword">uintptr</span>, <span class="number">1</span>)</span><br><span class="line">	runtime.Callers(<span class="number">2</span>, pc)</span><br><span class="line">	f := runtime.FuncForPC(pc[<span class="number">0</span>])</span><br><span class="line">	<span class="keyword">return</span> f.Name()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下是代码执行结果:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[Running] go run &quot;.../easy-tips/go/src/patterns/template/templateOther.go&quot;</span><br><span class="line">main.(*Lottery).checkSerialNo 校验活动编号(serial_no)是否存在、并获取活动信息...</span><br><span class="line">main.(*Lottery).checkStatus 校验活动、场次是否正在进行...</span><br><span class="line">main.(*AmountDraw).checkParams 按数额范围区间抽奖:特殊参数校验...</span><br><span class="line">main.(*Lottery).checkTimesByAct 活动抽奖次数校验...</span><br><span class="line">main.(*Lottery).consumePointsByAct 活动是否需要消费积分...</span><br><span class="line">main.(*Lottery).checkTimesBySession 活动抽奖次数校验...</span><br><span class="line">main.(*Lottery).getPrizesBySession 获取场次奖品信息...</span><br><span class="line">main.(*AmountDraw).getPrizesByNode 1. 判断属于哪个数额区间...</span><br><span class="line">main.(*AmountDraw).getPrizesByNode 2. 获取对应node的奖品信息...</span><br><span class="line">main.(*AmountDraw).getPrizesByNode 3. 复写原所有奖品信息(抽取该node节点的奖品)...</span><br><span class="line">main.(*Lottery).drawPrizes 抽奖...</span><br><span class="line">main.(*Lottery).checkPrizesStock 奖品数量判断...</span><br><span class="line">main.(*Lottery).packagePrizeInfo 组装奖品信息...</span><br></pre></td></tr></table></figure>
<p>demo2代码地址：<a href="https://github.com/TIGERB/easy-tips/blob/master/go/src/patterns/template/templateOther.go" target="_blank" rel="noopener">https://github.com/TIGERB/easy-tips/blob/master/go/src/patterns/template/templateOther.go</a></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>最后总结下，「模板模式」抽象过程的核心是把握<strong>不变</strong>与<strong>变</strong>：</p>
<ul>
<li>不变：<code>Run</code>方法里的抽奖步骤 -&gt; <code>被继承复用</code></li>
<li>变：不同场景下 -&gt; <code>被具体实现</code><ul>
<li><code>checkParams</code>参数校验逻辑</li>
<li><code>getPrizesByNode</code>获取该节点奖品的逻辑</li>
</ul>
</li>
</ul>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>

<!-- Comments -->
<div>
    


</div>



            </div>
        </div>

        <!-- Footer -->
<footer id="footer">
    <div class="inner">
        <section>
            <h2>About</h2>
            <div>
                新一代轻量级「<a href='http://easy-php.tigerb.cn'>EasyPHP</a>」框架作者，「<a href='http://skrshop.tech/'>《电商设计手册 | SkrShop》</a>」作者，「<a href='http://tigerb.cn/go/patterns'>《Go设计模式实战》系列</a>」作者，「<a href='http://tigerb.cn/go/kernal'>《Go语言轻松进阶》系列</a>」作者。拥有创业&上市公司电商开发经验，现于小米集团从事后端开发工作。
            </div>
        </section>
        <section>
            <h2>Follow</h2>
            <ul class="icons">
                
                    <li><a href="https://twitter.com/CODERCOOKER" class="icon style2 fa-twitter" target="_blank" ><span class="label">Twitter</span></a></li>
                
                
                
                    <li><a href="https://www.instagram.com/codercooker/" class="icon style2 fa-instagram" target="_blank" ><span class="label">Instagram</span></a></li>
                
                
                
                    <li><a href="https://github.com/TIGERB" class="icon style2 fa-github" target="_blank" ><span class="label">GitHub</span></a></li>
                
                
                
                
                
                    <li><a href="mailto:tigerbcode@gmail.com" class="icon style2 fa-envelope-o" target="_blank" ><span class="label">Email</span></a></li>
                
                
                    <li><a href="\atom.xml" class="icon style2 fa-rss" target="_blank" ><span class="label">RSS</span></a></li>
                
            </ul>
        </section>
        <ul class="copyright">
            <li>&copy; TIGERB.cn All right reserved. 津ICP备17006784号-2</li>
            <li><a href="https://juejin.im/user/5855e82d1b69e6006c9278b4" target="_blank">juejin</a></li>
            <li><a href="https://segmentfault.com/u/tigerb" target="_blank">Segmentfault</a></li>
            <li><a href="http://skrshop.tech/">电商设计手册 | SkrShop</a></li>
            <li><a href="https://dayutalk.cn/">大愚Talk</a></li>
        </ul>
    </div>
</footer>
    </div>

    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- skel -->
<script src="/js/skel.min.js"></script>

<!-- Custom Code -->
<script src="/js/util.js"></script>

<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script>
<![endif]-->

<!-- Custom Code -->
<script src="/js/main.js"></script>

<!-- Gallery -->
<script src="https://cdn.bootcss.com/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->


</body>

</html>