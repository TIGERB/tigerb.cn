<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!--Description-->
    
        <meta name="description" content="Trying to be the person you want to be.">
    

    <!--Author-->
    
        <meta name="author" content="TIGERB">
    

    <!--Open Graph Title-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="TIGERB"/>

    <!--Page Cover-->
    
        <meta property="og:image" content="undefined"/>
    

    <!-- Title -->
    
    <title>TIGERB</title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/sass/main.css">

    <!--[if lt IE 8]>
        <script src="/js/ie/html5shiv.js"></script>
    <![endif]-->

    <!--[if lt IE 8]>
        <link rel="stylesheet" href="/sass/ie8.css">
    <![endif]-->

    <!--[if lt IE 9]>
        <link rel="stylesheet" href="/sass/ie9.css">
    <![endif]-->

    <!-- Gallery -->
    <link href="https://cdn.bootcss.com/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    


    <script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?30c7e7d53256334a8dc1cf524fcc77f6";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
    })();
    </script>

</head>

<body>

    <div id="wrapper">

        <!-- Menu -->
        <!-- Header -->
<header id="header">
    <div class="inner">

        <!-- Logo -->
        <a href="/" class="logo">
            <span class="symbol"><img src="http://cdn.tigerb.cn/20190707142019.png" alt="" /></span><span class="title">TIGERB</span>
        </a>

        <!-- Nav -->
        <nav>
            <ul>
                <li><a href="#menu">Menu</a></li>
            </ul>
        </nav>

    </div>
</header>

<!-- Menu -->
<nav id="menu">
    <h2>Menu</h2>
    <ul>
        
            <li>
                <a href="/">首页</a>
            </li>
        
            <li>
                <a href="https://github.com/TIGERB">Github</a>
            </li>
        
            <li>
                <a href="https://segmentfault.com/u/tigerb">Segmentfault</a>
            </li>
        
            <li>
                <a href="https://juejin.im/user/5855e82d1b69e6006c9278b4">掘金</a>
            </li>
        
    </ul>
</nav>


        <div id="main">
            <div class="inner">

                <!-- Main Content -->
                

    <h1 class="title">No Code No Life</h1>
    <div class="meta">
        2021-01-08
    </div>


<span class="image main"><img src="No Code No Life" alt="" /></span>


<!-- Gallery -->


<!-- Content -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css"><div class=".article-gallery" <h2="" id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言<p>本系列主要分享，如何在我们的真实业务场景中使用设计模式。</p>
<p>本系列文章主要采用如下结构：</p>
<ul>
<li>什么是「XX设计模式」？</li>
<li>什么真实业务场景可以使用「XX设计模式」？</li>
<li>怎么用「XX设计模式」？</li>
</ul>
<h2 id="什么是「观察者模式」？"><a href="#什么是「观察者模式」？" class="headerlink" title="什么是「观察者模式」？"></a>什么是「观察者模式」？</h2><blockquote>
<p>观察者观察被观察者，被观察者通知观察者</p>
</blockquote>
<p>我们用“订阅通知”翻译下「观察者模式」的概念，结果：</p>
<blockquote>
<p>“订阅者订阅主题，主题通知订阅者”</p>
</blockquote>
<p>是不是容易理解多了，我们再来拆解下这句话，得到：</p>
<ul>
<li>两个对象<ul>
<li>被观察者 -&gt; 主题</li>
<li>观察者 -&gt; 订阅者</li>
</ul>
</li>
<li>两个动作<ul>
<li>订阅 -&gt; 订阅者<strong>订阅</strong>主题</li>
<li>通知 -&gt; 主题发生变动<strong>通知</strong>订阅者</li>
</ul>
</li>
</ul>
<p>观察者模式的优势：</p>
<ul>
<li>高内聚 -&gt; 不同业务代码变动互不影响</li>
<li>可复用 -&gt; 新的业务(就是新的订阅者)订阅不同接口(主题，就是这里的接口)</li>
<li>极易扩展 -&gt; 新增接口(就是新增主题)；新增业务(就是新增订阅者)；</li>
</ul>
<p>其实说白了，就是分布式架构中使用消息机制MQ解耦业务的优势，是不是这么一想很容易理解了。</p>
<h2 id="什么真实业务场景可以用「观察者模式」？"><a href="#什么真实业务场景可以用「观察者模式」？" class="headerlink" title="什么真实业务场景可以用「观察者模式」？"></a>什么真实业务场景可以用「观察者模式」？</h2><blockquote>
<p>所有发生变更，需要通知的业务场景</p>
</blockquote>
<p>详细说：只要发生了某些变化，需要通知依赖了这些变化的具体事物的业务场景。</p>
<blockquote>
<p>我们有哪些真实业务场景可以用「观察者模式」呢？</p>
</blockquote>
<p>比如，订单逆向流，也就是订单成立之后的各种取消操作(本文不讨论售后)，主要有如下取消类型：</p>
<table>
<thead>
<tr>
<th>订单取消类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>未支付取消订单</td>
</tr>
<tr>
<td>超时关单</td>
</tr>
<tr>
<td>已支付取消订单</td>
</tr>
<tr>
<td>取消发货单</td>
</tr>
<tr>
<td>拒收</td>
</tr>
</tbody>
</table>
<p>在触发这些<strong>取消操作</strong>都要进行各种各样的子操作，显而易见不同的<strong>取消操作</strong>所涉及的子操作是存在交集的。其次，已支付取消订单的子操作应该是所有订单取消类型最全的，其他类型的复用代码即可，除了分装成函数片段，还有什么更好的封装方式吗？答案：「观察者模式」。</p>
<p>接着我们来分析下订单逆向流业务中的<strong>变</strong>与<strong>不变</strong>：</p>
<ul>
<li>变<ul>
<li>新增取消类型</li>
<li>新增子操作</li>
<li>修改某个子操作的逻辑</li>
<li>取消类型和子操作的对应关系</li>
</ul>
</li>
<li>不变<ul>
<li>已存在的取消类型</li>
<li>已存在的子操作(在外界看来)</li>
</ul>
</li>
</ul>
<h2 id="怎么用「观察者模式」？"><a href="#怎么用「观察者模式」？" class="headerlink" title="怎么用「观察者模式」？"></a>怎么用「观察者模式」？</h2><p>关于怎么用，完全可以生搬硬套我总结的使用设计模式的四个步骤：</p>
<ul>
<li>业务梳理</li>
<li>业务流程图</li>
<li>代码建模</li>
<li>代码demo</li>
</ul>
<h4 id="业务梳理"><a href="#业务梳理" class="headerlink" title="业务梳理"></a>业务梳理</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">注：本文于单体架构背景探讨业务的实现过程，简单容易理解。</span><br></pre></td></tr></table></figure>
<p>第一步，梳理出所有存在的的逆向业务的子操作，如下：</p>
<table>
<thead>
<tr>
<th>所有子操作</th>
</tr>
</thead>
<tbody>
<tr>
<td>修改订单状态</td>
</tr>
<tr>
<td>记录订单状态变更日志</td>
</tr>
<tr>
<td>退优惠券</td>
</tr>
<tr>
<td>还优惠活动资格</td>
</tr>
<tr>
<td>还库存</td>
</tr>
<tr>
<td>还礼品卡</td>
</tr>
<tr>
<td>退钱包余额</td>
</tr>
<tr>
<td>修改发货单状态</td>
</tr>
<tr>
<td>记录发货单状态变更日志</td>
</tr>
<tr>
<td>生成退款单</td>
</tr>
<tr>
<td>生成发票-红票</td>
</tr>
<tr>
<td>发邮件</td>
</tr>
<tr>
<td>发短信</td>
</tr>
<tr>
<td>发微信消息</td>
</tr>
</tbody>
</table>
<p>第二步，找到不同订单取消类型和这些子操作的关系，如下：</p>
<table>
<thead>
<tr>
<th>订单取消类型(“主题”)(被观察者)</th>
<th>子操作(“订阅者”)(观察者)</th>
</tr>
</thead>
<tbody>
<tr>
<td>取消未支付订单</td>
<td>-</td>
</tr>
<tr>
<td>-</td>
<td>修改订单状态</td>
</tr>
<tr>
<td>-</td>
<td>记录订单状态变更日志</td>
</tr>
<tr>
<td>-</td>
<td>退优惠券</td>
</tr>
<tr>
<td>-</td>
<td>还优惠活动资格</td>
</tr>
<tr>
<td>-</td>
<td>还库存</td>
</tr>
<tr>
<td>超时关单</td>
<td>-</td>
</tr>
<tr>
<td>-</td>
<td>修改订单状态</td>
</tr>
<tr>
<td>-</td>
<td>记录订单状态变更日志</td>
</tr>
<tr>
<td>-</td>
<td>退优惠券</td>
</tr>
<tr>
<td>-</td>
<td>还优惠活动资格</td>
</tr>
<tr>
<td>-</td>
<td>还库存</td>
</tr>
<tr>
<td>-</td>
<td>发邮件</td>
</tr>
<tr>
<td>-</td>
<td>发短信</td>
</tr>
<tr>
<td>-</td>
<td>发微信消息</td>
</tr>
<tr>
<td>已支付取消订单(未生成发货单)</td>
<td>-</td>
</tr>
<tr>
<td>-</td>
<td>修改订单状态</td>
</tr>
<tr>
<td>-</td>
<td>记录订单状态变更日志</td>
</tr>
<tr>
<td>-</td>
<td>还优惠活动资格(看情况)</td>
</tr>
<tr>
<td>-</td>
<td>还库存</td>
</tr>
<tr>
<td>-</td>
<td>还礼品卡</td>
</tr>
<tr>
<td>-</td>
<td>退钱包余额</td>
</tr>
<tr>
<td>-</td>
<td>生成退款单</td>
</tr>
<tr>
<td>-</td>
<td>生成发票-红票</td>
</tr>
<tr>
<td>-</td>
<td>发邮件</td>
</tr>
<tr>
<td>-</td>
<td>发短信</td>
</tr>
<tr>
<td>-</td>
<td>发微信消息</td>
</tr>
<tr>
<td>取消发货单(未发货)</td>
<td>-</td>
</tr>
<tr>
<td>-</td>
<td>修改订单状态</td>
</tr>
<tr>
<td>-</td>
<td>记录订单状态变更日志</td>
</tr>
<tr>
<td>-</td>
<td>修改发货单状态</td>
</tr>
<tr>
<td>-</td>
<td>记录发货单状态变更日志</td>
</tr>
<tr>
<td>-</td>
<td>还库存</td>
</tr>
<tr>
<td>-</td>
<td>还礼品卡</td>
</tr>
<tr>
<td>-</td>
<td>退钱包余额</td>
</tr>
<tr>
<td>-</td>
<td>生成退款单</td>
</tr>
<tr>
<td>-</td>
<td>生成发票-红票</td>
</tr>
<tr>
<td>-</td>
<td>发邮件</td>
</tr>
<tr>
<td>-</td>
<td>发短信</td>
</tr>
<tr>
<td>-</td>
<td>发微信消息</td>
</tr>
<tr>
<td>拒收</td>
<td>-</td>
</tr>
<tr>
<td>-</td>
<td>修改订单状态</td>
</tr>
<tr>
<td>-</td>
<td>记录订单状态变更日志</td>
</tr>
<tr>
<td>-</td>
<td>修改发货单状态</td>
</tr>
<tr>
<td>-</td>
<td>记录发货单状态变更日志</td>
</tr>
<tr>
<td>-</td>
<td>还库存</td>
</tr>
<tr>
<td>-</td>
<td>还礼品卡</td>
</tr>
<tr>
<td>-</td>
<td>退钱包余额</td>
</tr>
<tr>
<td>-</td>
<td>生成退款单</td>
</tr>
<tr>
<td>-</td>
<td>生成发票-红票</td>
</tr>
<tr>
<td>-</td>
<td>发邮件</td>
</tr>
<tr>
<td>-</td>
<td>发短信</td>
</tr>
<tr>
<td>-</td>
<td>发微信消息</td>
</tr>
</tbody>
</table>
<blockquote>
<p>注：流程不一定完全准确、全面。</p>
</blockquote>
<p>结论：</p>
<ul>
<li>不同的订单取消类型的子操作存在交集，子操作可被复用。</li>
<li>子操作可被看作“订阅者”(也就是观察者)</li>
<li>订单取消类型可被看作是“主题”(也就是被观察者)</li>
<li>不同子操作(“订阅者”)(观察者)<strong>订阅</strong>订单取消类型(“主题”)(被观察者)</li>
<li>订单取消类型(“主题”)(被观察者)<strong>通知</strong>子操作(“订阅者”)(观察者)</li>
</ul>
<h4 id="业务流程图"><a href="#业务流程图" class="headerlink" title="业务流程图"></a>业务流程图</h4><p>我们通过梳理的文本业务流程得到了如下的业务流程图：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">注：本文于单体架构背景探讨业务的实现过程，简单容易理解。</span><br></pre></td></tr></table></figure>
<p><a href="http://cdn.tigerb.cn/20200410131427.png" class="gallery-item" target="_blank" rel="noopener"><img src="http://cdn.tigerb.cn/20200410131427.png" alt=""></a></p>
<h4 id="代码建模"><a href="#代码建模" class="headerlink" title="代码建模"></a>代码建模</h4><p>「观察者模式」的核心是两个接口：</p>
<ul>
<li>“主题”(被观察者)接口<code>Observable</code><ul>
<li>抽象方法<code>Attach</code>: 增加“订阅者”</li>
<li>抽象方法<code>Detach</code>: 删除“订阅者”</li>
<li>抽象方法<code>Notify</code>: 通知“订阅者”</li>
</ul>
</li>
<li>“订阅者”(观察者)接口<code>ObserverInterface</code><ul>
<li>抽象方法<code>Do</code>: 自身的业务</li>
</ul>
</li>
</ul>
<p>订单逆向流的业务下，我们需要实现这两个接口:</p>
<ul>
<li>具体订单取消的动作实现“主题”接口<code>Observable</code></li>
<li>子逻辑实现“订阅者”接口<code>ObserverInterface</code></li>
</ul>
<p>伪代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// ------------这里实现一个具体的“主题”------------</span><br><span class="line"></span><br><span class="line">具体订单取消的动作实现“主题”(被观察者)接口`Observable`。得到一个具体的“主题”:</span><br><span class="line"></span><br><span class="line">- 订单取消的动作的“主题”结构体`ObservableConcrete`</span><br><span class="line">    +  成员属性`observerList []ObserverInterface`:订阅者列表</span><br><span class="line">    +  具体方法`Attach`: 增加子逻辑</span><br><span class="line">    +  具体方法`Detach`: 删除子逻辑</span><br><span class="line">    +  具体方法`Notify`: 通知子逻辑</span><br><span class="line"></span><br><span class="line">// ------------这里实现所有具体的“订阅者”------------</span><br><span class="line"></span><br><span class="line">子逻辑实现“订阅者”接口`ObserverInterface`:</span><br><span class="line"></span><br><span class="line">- 具体“订阅者”也就是子逻辑`OrderStatus`</span><br><span class="line">    +  实现方法`Do`: 修改订单状态</span><br><span class="line">- 具体“订阅者”也就是子逻辑`OrderStatusLog`</span><br><span class="line">    +  实现方法`Do`: 记录订单状态变更日志</span><br><span class="line">- 具体“订阅者”也就是子逻辑`CouponRefund`</span><br><span class="line">    +  实现方法`Do`: 退优惠券</span><br><span class="line">- 具体“订阅者”也就是子逻辑`PromotionRefund`</span><br><span class="line">    +  实现方法`Do`: 还优惠活动资格</span><br><span class="line">- 具体“订阅者”也就是子逻辑`StockRefund`</span><br><span class="line">    +  实现方法`Do`: 还库存</span><br><span class="line">- 具体“订阅者”也就是子逻辑`GiftCardRefund`</span><br><span class="line">    +  实现方法`Do`: 还礼品卡</span><br><span class="line">- 具体“订阅者”也就是子逻辑`WalletRefund`</span><br><span class="line">    +  实现方法`Do`: 退钱包余额</span><br><span class="line">- 具体“订阅者”也就是子逻辑`DeliverBillStatus`</span><br><span class="line">    +  实现方法`Do`: 修改发货单状态</span><br><span class="line">- 具体“订阅者”也就是子逻辑`DeliverBillStatusLog`</span><br><span class="line">    +  实现方法`Do`: 记录发货单状态变更日志</span><br><span class="line">- 具体“订阅者”也就是子逻辑`Refund`</span><br><span class="line">    +  实现方法`Do`: 生成退款单</span><br><span class="line">- 具体“订阅者”也就是子逻辑`Invoice`</span><br><span class="line">    +  实现方法`Do`: 生成发票-红票</span><br><span class="line">- 具体“订阅者”也就是子逻辑`Email`</span><br><span class="line">    +  实现方法`Do`: 发邮件</span><br><span class="line">- 具体“订阅者”也就是子逻辑`Sms`</span><br><span class="line">    +  实现方法`Do`: 发短信</span><br><span class="line">- 具体“订阅者”也就是子逻辑`WechatNotify`</span><br><span class="line">    +  实现方法`Do`: 发微信消息</span><br></pre></td></tr></table></figure>
<p>同时得到了我们的UML图：</p>
<p><a href="http://cdn.tigerb.cn/20200411181215.jpg" class="gallery-item" target="_blank" rel="noopener"><img src="http://cdn.tigerb.cn/20200411181215.jpg" alt=""></a></p>
<h4 id="代码demo"><a href="#代码demo" class="headerlink" title="代码demo"></a>代码demo</h4><figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">//------------------------------------------------------------</span></span><br><span class="line"><span class="comment">//Go设计模式实战系列</span></span><br><span class="line"><span class="comment">//观察者模式</span></span><br><span class="line"><span class="comment">//@auhtor TIGERB&lt;https://github.com/TIGERB&gt;</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"reflect"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Observable 被观察者</span></span><br><span class="line"><span class="keyword">type</span> Observable <span class="keyword">interface</span> &#123;</span><br><span class="line">	Attach(observer ...ObserverInterface) Observable</span><br><span class="line">	Detach(observer ObserverInterface) Observable</span><br><span class="line">	Notify() error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ObservableConcrete 一个具体的 订单状态变化的被观察者</span></span><br><span class="line"><span class="keyword">type</span> ObservableConcrete <span class="keyword">struct</span> &#123;</span><br><span class="line">	observerList []ObserverInterface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Attach 注册观察者</span></span><br><span class="line"><span class="comment">// @param $observer ObserverInterface 观察者列表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *ObservableConcrete)</span> <span class="title">Attach</span><span class="params">(observer ...ObserverInterface)</span> <span class="title">Observable</span></span> &#123;</span><br><span class="line">	o.observerList = <span class="built_in">append</span>(o.observerList, observer...)</span><br><span class="line">	<span class="keyword">return</span> o</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Detach 注销观察者</span></span><br><span class="line"><span class="comment">// @param $observer ObserverInterface 待注销的观察者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *ObservableConcrete)</span> <span class="title">Detach</span><span class="params">(observer ObserverInterface)</span> <span class="title">Observable</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(o.observerList) == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> o</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> k, observerItem := <span class="keyword">range</span> o.observerList &#123;</span><br><span class="line">		<span class="keyword">if</span> observer == observerItem &#123;</span><br><span class="line">			fmt.Println(runFuncName(), <span class="string">"注销:"</span>, reflect.TypeOf(observer))</span><br><span class="line">			o.observerList = <span class="built_in">append</span>(o.observerList[:k], o.observerList[k+<span class="number">1</span>:]...)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> o</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Notify 通知观察者</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *ObservableConcrete)</span> <span class="title">Notify</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code ...</span></span><br><span class="line">	<span class="keyword">for</span> _, observer := <span class="keyword">range</span> o.observerList &#123;</span><br><span class="line">		<span class="keyword">if</span> err = observer.Do(o); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ObserverInterface 定义一个观察者的接口</span></span><br><span class="line"><span class="keyword">type</span> ObserverInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// 自身的业务</span></span><br><span class="line">	Do(o Observable) error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderStatus 修改订单状态</span></span><br><span class="line"><span class="keyword">type</span> OrderStatus <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *OrderStatus)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"修改订单状态..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderStatusLog 记录订单状态变更日志</span></span><br><span class="line"><span class="keyword">type</span> OrderStatusLog <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *OrderStatusLog)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"记录订单状态变更日志..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CouponRefund 退优惠券</span></span><br><span class="line"><span class="keyword">type</span> CouponRefund <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *CouponRefund)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"退优惠券..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PromotionRefund 还优惠活动资格</span></span><br><span class="line"><span class="keyword">type</span> PromotionRefund <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *PromotionRefund)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"还优惠活动资格..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StockRefund 还库存</span></span><br><span class="line"><span class="keyword">type</span> StockRefund <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *StockRefund)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"还库存..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GiftCardRefund 还礼品卡</span></span><br><span class="line"><span class="keyword">type</span> GiftCardRefund <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *GiftCardRefund)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"还礼品卡..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WalletRefund 退钱包余额</span></span><br><span class="line"><span class="keyword">type</span> WalletRefund <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *WalletRefund)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"退钱包余额..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DeliverBillStatus 修改发货单状态</span></span><br><span class="line"><span class="keyword">type</span> DeliverBillStatus <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *DeliverBillStatus)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"修改发货单状态..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DeliverBillStatusLog 记录发货单状态变更日志</span></span><br><span class="line"><span class="keyword">type</span> DeliverBillStatusLog <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *DeliverBillStatusLog)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"记录发货单状态变更日志..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Refund 生成退款单</span></span><br><span class="line"><span class="keyword">type</span> Refund <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *Refund)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"生成退款单..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Invoice 生成发票-红票</span></span><br><span class="line"><span class="keyword">type</span> Invoice <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *Invoice)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"生成发票-红票..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Email 发邮件</span></span><br><span class="line"><span class="keyword">type</span> Email <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *Email)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"发邮件..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sms 发短信</span></span><br><span class="line"><span class="keyword">type</span> Sms <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *Sms)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"发短信..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WechatNotify 发微信消息</span></span><br><span class="line"><span class="keyword">type</span> WechatNotify <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Do 具体业务</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(observer *WechatNotify)</span> <span class="title">Do</span><span class="params">(o Observable)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// code...</span></span><br><span class="line">	fmt.Println(runFuncName(), <span class="string">"发微信消息..."</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端调用</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建 未支付取消订单 “主题”</span></span><br><span class="line">	fmt.Println(<span class="string">"----------------------- 未支付取消订单 “主题”"</span>)</span><br><span class="line">	orderUnPaidCancelSubject := &amp;ObservableConcrete&#123;&#125;</span><br><span class="line">	orderUnPaidCancelSubject.Attach(</span><br><span class="line">		&amp;OrderStatus&#123;&#125;,</span><br><span class="line">		&amp;OrderStatusLog&#123;&#125;,</span><br><span class="line">		&amp;CouponRefund&#123;&#125;,</span><br><span class="line">		&amp;PromotionRefund&#123;&#125;,</span><br><span class="line">		&amp;StockRefund&#123;&#125;,</span><br><span class="line">	)</span><br><span class="line">	orderUnPaidCancelSubject.Notify()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建 超时关单 “主题”</span></span><br><span class="line">	fmt.Println(<span class="string">"----------------------- 超时关单 “主题”"</span>)</span><br><span class="line">	orderOverTimeSubject := &amp;ObservableConcrete&#123;&#125;</span><br><span class="line">	orderOverTimeSubject.Attach(</span><br><span class="line">		&amp;OrderStatus&#123;&#125;,</span><br><span class="line">		&amp;OrderStatusLog&#123;&#125;,</span><br><span class="line">		&amp;CouponRefund&#123;&#125;,</span><br><span class="line">		&amp;PromotionRefund&#123;&#125;,</span><br><span class="line">		&amp;StockRefund&#123;&#125;,</span><br><span class="line">		&amp;Email&#123;&#125;,</span><br><span class="line">		&amp;Sms&#123;&#125;,</span><br><span class="line">		&amp;WechatNotify&#123;&#125;,</span><br><span class="line">	)</span><br><span class="line">	orderOverTimeSubject.Notify()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建 已支付取消订单 “主题”</span></span><br><span class="line">	fmt.Println(<span class="string">"----------------------- 已支付取消订单 “主题”"</span>)</span><br><span class="line">	orderPaidCancelSubject := &amp;ObservableConcrete&#123;&#125;</span><br><span class="line">	orderPaidCancelSubject.Attach(</span><br><span class="line">		&amp;OrderStatus&#123;&#125;,</span><br><span class="line">		&amp;OrderStatusLog&#123;&#125;,</span><br><span class="line">		&amp;CouponRefund&#123;&#125;,</span><br><span class="line">		&amp;PromotionRefund&#123;&#125;,</span><br><span class="line">		&amp;StockRefund&#123;&#125;,</span><br><span class="line">		&amp;GiftCardRefund&#123;&#125;,</span><br><span class="line">		&amp;WalletRefund&#123;&#125;,</span><br><span class="line">		&amp;Refund&#123;&#125;,</span><br><span class="line">		&amp;Invoice&#123;&#125;,</span><br><span class="line">		&amp;Email&#123;&#125;,</span><br><span class="line">		&amp;Sms&#123;&#125;,</span><br><span class="line">		&amp;WechatNotify&#123;&#125;,</span><br><span class="line">	)</span><br><span class="line">	orderPaidCancelSubject.Notify()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建 取消发货单 “主题”</span></span><br><span class="line">	fmt.Println(<span class="string">"----------------------- 取消发货单 “主题”"</span>)</span><br><span class="line">	deliverBillCancelSubject := &amp;ObservableConcrete&#123;&#125;</span><br><span class="line">	deliverBillCancelSubject.Attach(</span><br><span class="line">		&amp;OrderStatus&#123;&#125;,</span><br><span class="line">		&amp;OrderStatusLog&#123;&#125;,</span><br><span class="line">		&amp;DeliverBillStatus&#123;&#125;,</span><br><span class="line">		&amp;DeliverBillStatusLog&#123;&#125;,</span><br><span class="line">		&amp;StockRefund&#123;&#125;,</span><br><span class="line">		&amp;GiftCardRefund&#123;&#125;,</span><br><span class="line">		&amp;WalletRefund&#123;&#125;,</span><br><span class="line">		&amp;Refund&#123;&#125;,</span><br><span class="line">		&amp;Invoice&#123;&#125;,</span><br><span class="line">		&amp;Email&#123;&#125;,</span><br><span class="line">		&amp;Sms&#123;&#125;,</span><br><span class="line">		&amp;WechatNotify&#123;&#125;,</span><br><span class="line">	)</span><br><span class="line">	deliverBillCancelSubject.Notify()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建 拒收 “主题”</span></span><br><span class="line">	fmt.Println(<span class="string">"----------------------- 拒收 “主题”"</span>)</span><br><span class="line">	deliverBillRejectSubject := &amp;ObservableConcrete&#123;&#125;</span><br><span class="line">	deliverBillRejectSubject.Attach(</span><br><span class="line">		&amp;OrderStatus&#123;&#125;,</span><br><span class="line">		&amp;OrderStatusLog&#123;&#125;,</span><br><span class="line">		&amp;DeliverBillStatus&#123;&#125;,</span><br><span class="line">		&amp;DeliverBillStatusLog&#123;&#125;,</span><br><span class="line">		&amp;StockRefund&#123;&#125;,</span><br><span class="line">		&amp;GiftCardRefund&#123;&#125;,</span><br><span class="line">		&amp;WalletRefund&#123;&#125;,</span><br><span class="line">		&amp;Refund&#123;&#125;,</span><br><span class="line">		&amp;Invoice&#123;&#125;,</span><br><span class="line">		&amp;Email&#123;&#125;,</span><br><span class="line">		&amp;Sms&#123;&#125;,</span><br><span class="line">		&amp;WechatNotify&#123;&#125;,</span><br><span class="line">	)</span><br><span class="line">	deliverBillRejectSubject.Notify()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 未来可以快速的根据业务的变化 创建新的主题 从而快速构建新的业务接口</span></span><br><span class="line">	fmt.Println(<span class="string">"----------------------- 未来的扩展..."</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取正在运行的函数名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runFuncName</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	pc := <span class="built_in">make</span>([]<span class="keyword">uintptr</span>, <span class="number">1</span>)</span><br><span class="line">	runtime.Callers(<span class="number">2</span>, pc)</span><br><span class="line">	f := runtime.FuncForPC(pc[<span class="number">0</span>])</span><br><span class="line">	<span class="keyword">return</span> f.Name()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码运行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[Running] go run &quot;../easy-tips/go/src/patterns/observer/observer.go&quot;</span><br><span class="line">----------------------- 未支付取消订单 “主题”</span><br><span class="line">main.(*OrderStatus).Do 修改订单状态...</span><br><span class="line">main.(*OrderStatusLog).Do 记录订单状态变更日志...</span><br><span class="line">main.(*CouponRefund).Do 退优惠券...</span><br><span class="line">main.(*PromotionRefund).Do 还优惠活动资格...</span><br><span class="line">main.(*StockRefund).Do 还库存...</span><br><span class="line">----------------------- 超时关单 “主题”</span><br><span class="line">main.(*OrderStatus).Do 修改订单状态...</span><br><span class="line">main.(*OrderStatusLog).Do 记录订单状态变更日志...</span><br><span class="line">main.(*CouponRefund).Do 退优惠券...</span><br><span class="line">main.(*PromotionRefund).Do 还优惠活动资格...</span><br><span class="line">main.(*StockRefund).Do 还库存...</span><br><span class="line">main.(*Email).Do 发邮件...</span><br><span class="line">main.(*Sms).Do 发短信...</span><br><span class="line">main.(*WechatNotify).Do 发微信消息...</span><br><span class="line">----------------------- 已支付取消订单 “主题”</span><br><span class="line">main.(*OrderStatus).Do 修改订单状态...</span><br><span class="line">main.(*OrderStatusLog).Do 记录订单状态变更日志...</span><br><span class="line">main.(*CouponRefund).Do 退优惠券...</span><br><span class="line">main.(*PromotionRefund).Do 还优惠活动资格...</span><br><span class="line">main.(*StockRefund).Do 还库存...</span><br><span class="line">main.(*GiftCardRefund).Do 还礼品卡...</span><br><span class="line">main.(*WalletRefund).Do 退钱包余额...</span><br><span class="line">main.(*Refund).Do 生成退款单...</span><br><span class="line">main.(*Invoice).Do 生成发票-红票...</span><br><span class="line">main.(*Email).Do 发邮件...</span><br><span class="line">main.(*Sms).Do 发短信...</span><br><span class="line">main.(*WechatNotify).Do 发微信消息...</span><br><span class="line">----------------------- 取消发货单 “主题”</span><br><span class="line">main.(*OrderStatus).Do 修改订单状态...</span><br><span class="line">main.(*OrderStatusLog).Do 记录订单状态变更日志...</span><br><span class="line">main.(*DeliverBillStatus).Do 修改发货单状态...</span><br><span class="line">main.(*DeliverBillStatusLog).Do 记录发货单状态变更日志...</span><br><span class="line">main.(*StockRefund).Do 还库存...</span><br><span class="line">main.(*GiftCardRefund).Do 还礼品卡...</span><br><span class="line">main.(*WalletRefund).Do 退钱包余额...</span><br><span class="line">main.(*Refund).Do 生成退款单...</span><br><span class="line">main.(*Invoice).Do 生成发票-红票...</span><br><span class="line">main.(*Email).Do 发邮件...</span><br><span class="line">main.(*Sms).Do 发短信...</span><br><span class="line">main.(*WechatNotify).Do 发微信消息...</span><br><span class="line">----------------------- 拒收 “主题”</span><br><span class="line">main.(*OrderStatus).Do 修改订单状态...</span><br><span class="line">main.(*OrderStatusLog).Do 记录订单状态变更日志...</span><br><span class="line">main.(*DeliverBillStatus).Do 修改发货单状态...</span><br><span class="line">main.(*DeliverBillStatusLog).Do 记录发货单状态变更日志...</span><br><span class="line">main.(*StockRefund).Do 还库存...</span><br><span class="line">main.(*GiftCardRefund).Do 还礼品卡...</span><br><span class="line">main.(*WalletRefund).Do 退钱包余额...</span><br><span class="line">main.(*Refund).Do 生成退款单...</span><br><span class="line">main.(*Invoice).Do 生成发票-红票...</span><br><span class="line">main.(*Email).Do 发邮件...</span><br><span class="line">main.(*Sms).Do 发短信...</span><br><span class="line">main.(*WechatNotify).Do 发微信消息...</span><br></pre></td></tr></table></figure>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>最后总结下，「观察者模式」抽象过程的核心是：</p>
<ul>
<li>被依赖的“主题”</li>
<li>被通知的“订阅者”</li>
<li>“订阅者”按需<strong>订阅</strong>“主题”</li>
<li>“主题”变化<strong>通知</strong>“订阅者”</li>
</ul>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>

<!-- Comments -->
<div>
    


</div>



            </div>
        </div>

        <!-- Footer -->
<footer id="footer">
    <div class="inner">
        <section>
            <h2>About</h2>
            <div>
                新一代轻量级「<a href='http://easy-php.tigerb.cn'>EasyPHP</a>」框架作者，「<a href='http://skrshop.tech/'>《电商设计手册 | SkrShop》</a>」作者，「<a href='http://tigerb.cn/go/patterns'>《Go设计模式实战》系列</a>」作者，「<a href='http://tigerb.cn/go/kernal'>《Go语言轻松进阶》系列</a>」作者。拥有创业&上市公司电商开发经验，现于小米集团从事后端开发工作。
            </div>
        </section>
        <section>
            <h2>Follow</h2>
            <ul class="icons">
                
                    <li><a href="https://twitter.com/CODERCOOKER" class="icon style2 fa-twitter" target="_blank" ><span class="label">Twitter</span></a></li>
                
                
                
                    <li><a href="https://www.instagram.com/codercooker/" class="icon style2 fa-instagram" target="_blank" ><span class="label">Instagram</span></a></li>
                
                
                
                    <li><a href="https://github.com/TIGERB" class="icon style2 fa-github" target="_blank" ><span class="label">GitHub</span></a></li>
                
                
                
                
                
                    <li><a href="mailto:tigerbcode@gmail.com" class="icon style2 fa-envelope-o" target="_blank" ><span class="label">Email</span></a></li>
                
                
                    <li><a href="\atom.xml" class="icon style2 fa-rss" target="_blank" ><span class="label">RSS</span></a></li>
                
            </ul>
        </section>
        <ul class="copyright">
            <li>&copy; TIGERB.cn All right reserved. 津ICP备17006784号-2</li>
            <li><a href="https://juejin.im/user/5855e82d1b69e6006c9278b4" target="_blank">juejin</a></li>
            <li><a href="https://segmentfault.com/u/tigerb" target="_blank">Segmentfault</a></li>
            <li><a href="http://skrshop.tech/">电商设计手册 | SkrShop</a></li>
            <li><a href="https://dayutalk.cn/">大愚Talk</a></li>
        </ul>
    </div>
</footer>
    </div>

    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- skel -->
<script src="/js/skel.min.js"></script>

<!-- Custom Code -->
<script src="/js/util.js"></script>

<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script>
<![endif]-->

<!-- Custom Code -->
<script src="/js/main.js"></script>

<!-- Gallery -->
<script src="https://cdn.bootcss.com/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->


</body>

</html>