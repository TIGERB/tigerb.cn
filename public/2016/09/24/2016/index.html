<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!--Description-->
    
        <meta name="description" content="No code No life">
    

    <!--Author-->
    
        <meta name="author" content="TIGERB">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="码码踩过的那些坑2016"/>
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="TIGERB"/>

    <!--Page Cover-->
    
        <meta property="og:image" content="undefined"/>
    

    <!-- Title -->
    
    <title>码码踩过的那些坑2016 - TIGERB</title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/sass/main.css">

    <!--[if lt IE 8]>
        <script src="/js/ie/html5shiv.js"></script>
    <![endif]-->

    <!--[if lt IE 8]>
        <link rel="stylesheet" href="/sass/ie8.css">
    <![endif]-->

    <!--[if lt IE 9]>
        <link rel="stylesheet" href="/sass/ie9.css">
    <![endif]-->

    <!-- Gallery -->
    <link href="https://cdn.bootcss.com/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    


    <script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?30c7e7d53256334a8dc1cf524fcc77f6";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
    })();
    </script>

</head>

<body>

    <div id="wrapper">

        <!-- Menu -->
        <!-- Header -->
<header id="header">
    <div class="inner">

        <!-- Logo -->
        <a href="/" class="logo">
            <span class="symbol"><img src="http://cdn.tigerb.cn/20190707142019.png" alt="" /></span><span class="title">TIGERB</span>
        </a>

        <!-- Nav -->
        <nav>
            <ul>
                <li><a href="#menu">Menu</a></li>
            </ul>
        </nav>

    </div>
</header>

<!-- Menu -->
<nav id="menu">
    <h2>Menu</h2>
    <ul>
        
            <li>
                <a href="/">首页</a>
            </li>
        
            <li>
                <a href="https://github.com/TIGERB">Github</a>
            </li>
        
            <li>
                <a href="https://segmentfault.com/u/tigerb">Segmentfault</a>
            </li>
        
            <li>
                <a href="https://juejin.im/user/5855e82d1b69e6006c9278b4">掘金</a>
            </li>
        
    </ul>
</nav>


        <div id="main">
            <div class="inner">

                <!-- Main Content -->
                

    <h1 class="title">码码踩过的那些坑2016</h1>
    <div class="meta">
        2016-09-24
    </div>


    <span class="image main"><img src="No Code No Life" alt="" /></span>


<!-- Gallery -->


<!-- Content -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css"><div class=".article-gallery" <p="">a little tips in my code career | 码码踩过的那些坑<em>2016</em><p></p>
<p>记一下这一年码码中我需要去了解的基础知识</p>
<hr>
<ol>
<li>关于设计模式</li>
<li>关于PHP</li>
<li>关于互联网协议</li>
</ol>
<hr>
<h2 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h2><h6 id="面向对象的设计原则"><a href="#面向对象的设计原则" class="headerlink" title="面向对象的设计原则"></a>面向对象的设计原则</h6><ul>
<li>对接口编程，不要对实现编程</li>
<li>使用对象之间的组合，减少对继承的使用</li>
<li>抽象用于不同的事物，而接口用于事物的行为</li>
</ul>
<h6 id="设计模式的设计原则"><a href="#设计模式的设计原则" class="headerlink" title="设计模式的设计原则"></a>设计模式的设计原则</h6><ul>
<li>开闭原则：对扩展开放，对修改封闭<ul>
<li>mean: 实例的内部不可修改，但可以增加新功能</li>
</ul>
</li>
<li>依赖倒转：对接口编程，依赖于抽象而不依赖于具体<ul>
<li>mean: 就是把公共的拿出来，定义成抽象类、接口、抽象方法，然后大家再去实现这个抽<br>象，实现的方法各有不同，各个实体相互独立没有依赖，各个实体离开谁都能活</li>
</ul>
</li>
<li>接口隔离：使用多个接口，而不是对一个接口编程，去依赖降低耦合<ul>
<li>mean: 就是抽象再抽象</li>
</ul>
</li>
<li>最少知道：减少内部依赖，尽可能的独立<ul>
<li>mean: 实现依赖注入容器，把依赖的实体注入到一个实例（所谓容器）</li>
</ul>
</li>
<li>合成复用：多个独立的实体合成聚合，而不是使用继承<ul>
<li>mean：尽可能不用继承，使用以上三种方式构成代码结构</li>
</ul>
</li>
<li>里氏代换：超类（父类）出现的地方，派生类（子类）都可以出现<ul>
<li>mean：能用父类实现的子类也能实现</li>
</ul>
</li>
</ul>
<h6 id="简单设计原则"><a href="#简单设计原则" class="headerlink" title="简单设计原则"></a>简单设计原则</h6><ul>
<li>通过所有测试:及需求为上</li>
<li>尽可能的消除重复：高内聚低耦合</li>
<li>尽可能的清晰表达：可读性</li>
<li>更少代码元素：常量，变量，函数，类，包 …… 都属于代码元素，降低复杂性</li>
<li>以上四个原则的重要程度依次降低</li>
</ul>
<p>核心：高内聚松耦合（单一职责），外部依赖，实体对抽象编程，抽象就是分层</p>
<h2 id="PHP"><a href="#PHP" class="headerlink" title="PHP"></a>PHP</h2><h6 id="client和nginx简易交互过程"><a href="#client和nginx简易交互过程" class="headerlink" title="client和nginx简易交互过程"></a>client和nginx简易交互过程</h6><ul>
<li>step1:client发起http请求</li>
<li>step2:dns服务器解析域名得到主机ip</li>
<li>step3:默认端口为80，通过ip+port建立tcp/ip链接</li>
<li>step4:建立连接的tcp/ip三次握手，建立成功发送数据包</li>
<li>step5:nginx匹配请求<ul>
<li>case .html: 静态内容，分发静态内容响应</li>
<li>case .php: php脚本，转发请求内容到php-fpm进程，分发php-fpm返回的内容响应</li>
</ul>
</li>
<li>step6:断开连接的tcp/ip四次握手，断开连接</li>
</ul>
<h6 id="nginx和php简易交互过程"><a href="#nginx和php简易交互过程" class="headerlink" title="nginx和php简易交互过程"></a>nginx和php简易交互过程</h6><ul>
<li>背景：web server和服务端语言交互依赖的是cgi(Common Gateway Interface)协议，由于cgi效率不高，后期产生了fastcgi协议(一种常驻型的cgi协议),php-cgi实现了fastcgi，但是相比php-cgi,php-fpm提供了更好的PHP进程管理方式，可以有效控制内存和进程、可以平滑重载PHP配置</li>
<li><p>流程：</p>
<ul>
<li><p>step1:nginx接收到一条http请求，会把环境变量，请求参数转变成php能懂的php变量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// nginx 配置资料</span><br><span class="line">location ~ \.php$ &#123;</span><br><span class="line">      include snippets/fastcgi-php.conf; //step1</span><br><span class="line">      fastcgi_pass unix:/run/php/php7.0-fpm.sock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>step2:nginx匹配到.php结尾的访问通过fastcgi_pass命令传递给php-fpm.sock文件，其实这里<br>的ngnix发挥的是反向代理的角色，把http协议请求转到fastcgi协议请求</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// nginx 配置资料</span><br><span class="line">location ~ \.php$ &#123;</span><br><span class="line">      include snippets/fastcgi-php.conf;</span><br><span class="line">      fastcgi_pass unix:/run/php/php7.0-fpm.sock;// step2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>step3:php-fpm.sock文件会被php-fpm的master进程所引用，这里nginx和php-fpm使用的是<br>linux的进程间通信方式unix domain socks，是一种基于文件而不是网络底册协议的通信方式</p>
</li>
<li>step4:php-fpm的master进程接收到请求后，会把请求分发到php-fpm的子进程，每个php-fpm<br>子进程都包含一个php解析器</li>
<li>step5:php-fpm进程处理完请求后返回给nginx</li>
</ul>
</li>
</ul>
<h6 id="知识碎片"><a href="#知识碎片" class="headerlink" title="知识碎片"></a>知识碎片</h6>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//phpfpm配置</span><br><span class="line"></span><br><span class="line">pm.max_children = 最大并发数</span><br><span class="line"></span><br><span class="line">详细的答案：</span><br><span class="line">pm.max_children 表示 php-fpm 能启动的子进程的最大数量。</span><br><span class="line">因为 php-fpm 是多进程单线程同步模式，即一个子进程同时最多处理一个请求，所以子进程数等于最大并发数。</span><br></pre></td></tr></table></figure>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//日志调试方法</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 超级调试</span><br><span class="line"> *</span><br><span class="line"> * 调试非本地环境或分布式环境，通过Log查看变量传递</span><br><span class="line"> * 写入变量值到\var\log\php_super_debug.log</span><br><span class="line"> * @param  mixed  $data     日志数据</span><br><span class="line"> * @param  string $log_path 日志路径</span><br><span class="line"> * @param  string $log_name 日志名称</span><br><span class="line"> * @return void       </span><br><span class="line"> */</span><br><span class="line">function super_debug($data, $log_path=&apos;\var\log\&apos;, $log_name=&apos;debug&apos;)</span><br><span class="line">&#123;</span><br><span class="line">  error_log(json_encode($data, JSON_UNESCAPED_UNICODE).&quot;\n&quot;, 3, $log_path.$log_name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// php实现下载图片</span><br><span class="line"></span><br><span class="line">header(&apos;Content-type: image/jpeg&apos;);</span><br><span class="line">header(&apos;Content-Disposition: attachment; filename=download_name.jpg&apos;);</span><br><span class="line">readfile($yourFilePath);</span><br></pre></td></tr></table></figure>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// php5.6开始干掉了@语法，php上传图片兼容版本写法</span><br><span class="line"></span><br><span class="line">if (class_exists(&apos;\CURLFile&apos;)) &#123;</span><br><span class="line">    curl_setopt($curl, CURLOPT_SAFE_UPLOAD, true);</span><br><span class="line">    $data = array(&apos;file&apos; =&gt; new \CURLFile(realpath($destination)));//5.5+</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    if (defined(&apos;CURLOPT_SAFE_UPLOAD&apos;)) &#123;</span><br><span class="line">        curl_setopt($curl, CURLOPT_SAFE_UPLOAD, false);</span><br><span class="line">    &#125;</span><br><span class="line">    $data = array(&apos;file&apos; =&gt; &apos;@&apos; . realpath($destination));//&lt;=5.5</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 序列化与反序列化</span><br><span class="line"></span><br><span class="line">概念:</span><br><span class="line">序列化：把变量(所有类型)转成能传输和储存的变量(不丢失原变量的属性和结构)</span><br><span class="line">反序列化：把字符串转成原变量</span><br><span class="line"></span><br><span class="line">函数：</span><br><span class="line">序列化：serialize, json_encode(不能序列化对象)</span><br><span class="line">反序列化：unserialize, json_decode</span><br></pre></td></tr></table></figure>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 记一个坑</span><br><span class="line"></span><br><span class="line">ip2long函数</span><br><span class="line">- 32位系统下会转成带符号的int，范围-2^31~2^31-1</span><br><span class="line">- 64位系统下会转成带不符号的int，范围0~2^32-1</span><br></pre></td></tr></table></figure>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># redis发布订阅</span><br><span class="line">ini_set(‘default_socket_timeout’, -1);</span><br><span class="line"></span><br><span class="line">$redis = new \Redis();</span><br><span class="line">$redis-&gt;pconnect(&apos;127.0.0.1&apos;, 6379);</span><br><span class="line"></span><br><span class="line">//订阅</span><br><span class="line">$redis-&gt;subscribe([&apos;msg&apos;], &apos;callfun&apos;);</span><br><span class="line"></span><br><span class="line">function callfun($redis, $channel, $msg)</span><br><span class="line">&#123;</span><br><span class="line">  var_dump([</span><br><span class="line">    &apos;redis&apos; =&gt; $redis,</span><br><span class="line">    &apos;channel&apos; =&gt; $channel,</span><br><span class="line">    &apos;msg&apos; =&gt; $msg</span><br><span class="line">  ]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//发布</span><br><span class="line">$redis = new \Redis();</span><br><span class="line">$redis-&gt;connect(&apos;127.0.0.1&apos;, 6379);</span><br><span class="line">$redis-&gt;publish(&apos;msg&apos;, &apos;moon cake&apos;);</span><br><span class="line">$redis-&gt;close();</span><br></pre></td></tr></table></figure>
<h6 id="技巧"><a href="#技巧" class="headerlink" title="技巧"></a>技巧</h6><ul>
<li><p>linux</p>
<ul>
<li>df -h: 更易读的查看磁盘空间</li>
<li>du -h –max-depth=1 file_path:查看文件夹占用的空间，–max-depth文件夹下显示层级</li>
<li>sudo rm -rf *.log：清理日志</li>
<li>socket<ul>
<li>http socket = ip:port</li>
<li>unix domain socket: unix process communication 进程间通信</li>
</ul>
</li>
<li>ubuntu16.04安装php5源：sudo apt-add-repository ppa:ondrej/php</li>
<li>ubuntu中文支持：sudo apt-get install language-pack-zh-hant language-pack-zh-hans</li>
</ul>
</li>
<li><p>mysql</p>
<ul>
<li>数据清理：TRUNCATE TABLE XXX</li>
<li>水平分表：MERGE关键字</li>
<li>完全克隆一张表：<ul>
<li>克隆表结构：CREATE TABLE table_copy LIKE table_destination</li>
<li>克隆数据：INSERT INTO table_copy SELECT * FORM table_destination</li>
</ul>
</li>
<li>重命名字段：ALTER TABLE table_destination CHANGE column_destination new_name data_type</li>
<li>导出数据： mysqldump -h 127.0.0.1 -u root -p “database_name” “table_name” –where=”condition” &gt; file_name.sql</li>
<li>导入数据：source “flie”</li>
</ul>
</li>
<li><p>php:</p>
<ul>
<li>json_encode($data, JSON_UNESCAPED_UNICODE)</li>
<li>php的自定义头信息都可以使用$<em>SERVER[‘HTTP</em>*’]来获取</li>
<li>如果你想知道脚本开始执行(译注：即服务器端收到客户端请求)的时刻，使用$_SERVER[‘REQUEST_TIME’]要好于time()</li>
<li>error_log(json_encode($data, JSON_UNESCAPED_UNICODE), 1/3, <a href="mailto:&#39;tigerbcoder@gmail.com" target="_blank" rel="noopener">&#39;tigerbcoder@gmail.com</a>/log_path’)</li>
<li>sudo watch service php5.6-fpm status</li>
<li>foreach后的好习惯reset指针位置，unset掉$key，$value</li>
<li>curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);</li>
<li>laravel [‘lærə,vɛl]</li>
<li>php中的语言结构：echo,exit(),print,empty(),unset(),isset(),list(),eval(),array()</li>
</ul>
</li>
<li>git:<ul>
<li>git commit –amend 重写最近commit message</li>
<li>git cherry-pick 移花接木</li>
</ul>
</li>
<li>composer:<ul>
<li>修改包来源: sudo composer config repositories.包名 vcs 包地址</li>
</ul>
</li>
</ul>
<h6 id="PHP的不足"><a href="#PHP的不足" class="headerlink" title="PHP的不足"></a>PHP的不足</h6><ul>
<li>PHP还是有很多不足的地方，比如无法进行高效的运算</li>
</ul>
<h2 id="互联网协议"><a href="#互联网协议" class="headerlink" title="互联网协议"></a>互联网协议</h2><ul>
<li>概括：从上到下，越上越接近用户，越下越接近硬件</li>
<li><p>应用层:</p>
<ul>
<li>规定应用程序的数据格式</li>
<li>[HEAD(以太网标头) [HEAD(IP标头) [HEAD(TCP标头) DATA(应用层数据包)]]]</li>
</ul>
</li>
<li><p>传输层(端口到端口的通信):</p>
<ul>
<li>端口：<ul>
<li>0到65535(2^16)的整数</li>
<li>进程使用网卡的编号</li>
<li>通过IP+mac确定主机，只要确定主机+端口(套接字socket)，就能进行程序间的通信</li>
</ul>
</li>
<li>UDP协议：<ul>
<li>数据包中加入端口依赖的新协议</li>
<li>数据包[HEAD(发送、接收mac) [HEAD(发送、接收ip) [HEAD(发送、接收端口) DATA]]]</li>
<li>简单，可靠性差，不知道对方是否接受包</li>
</ul>
</li>
<li>TCP协议：<ul>
<li>带有确认机制的UDP协议</li>
<li>过程复杂，实现困难，消耗资源<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tcp/ip connect: tcp/ip的三次握手</span><br><span class="line">        syn握手信号</span><br><span class="line">        -------------&gt;</span><br><span class="line">        syn/ack确认字符</span><br><span class="line">client  &lt;-------------  server</span><br><span class="line">        ack确认包</span><br><span class="line">        --------------&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>网络层(主机到主机的通信):</p>
<ul>
<li>IP协议<ul>
<li>ipv4:<ul>
<li>32个二进制位表示，由网络部分和主机部分构成，</li>
<li>子网掩码: 网络部分都为1，主机部分都为0，目的判断ip的网络部分，如255.255.255.0(11111111.11111111.11111111.00000000)</li>
<li>IP数据包：标头Head+数据Data,放进以太网数据包的Data部分[HEAD [HEAD DATA]]</li>
<li>IP数据包的传递：<ul>
<li>非同一网络：无法获得mac地址,发送数据到网关，网关处理</li>
<li>同一网络：mac地址填写FF:FF:FF:FF:FF:FF:FF，广播数据，对比ip，不符合丢包</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>链接层：</p>
<ul>
<li>定义数据包(帧Frame)<ul>
<li>标头(Head):数据包的一些说明项, 如发送者、接收者、数据类型</li>
<li>数据(Data):数据包的具体内容</li>
<li>数据包:[HEAD DATA]</li>
</ul>
</li>
<li>定义网卡和网卡唯一的mac地址<ul>
<li>以太网规定接入网络的所有终端都应该具有网卡接口，数据包必须是从一个网卡的mac地址到另一网卡接口的mac地址</li>
<li>mac全球唯一，16位16位进制组成，前6厂商编号，后6网卡流水号</li>
</ul>
</li>
<li>广播发送数据<ul>
<li>向本网络内的所有设备发送数据包，对比接收者mac地址，不是丢包，是接受</li>
</ul>
</li>
</ul>
</li>
<li><p>实体层：</p>
<ul>
<li>终端(pc，phone，pad…)的物理连接(光缆，电缆，路由…)，负责传递0和1信号</li>
</ul>
</li>
</ul>
</div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>

<!-- Tags -->



<div class="tags">
    <a href="/tags/年终总结/" class="button small">年终总结</a>
</div>



<!-- Qrcode -->
<div width="100px">
    <img src="http://cdn.tigerb.cn/wechat-blog-qrcode.jpg" alt="TIGERB" width="300px" style="display:block; margin: 30px auto 0px auto;">
</div>

<!-- Comments -->
<div>
    


</div>



            </div>
        </div>

        <!-- Footer -->
<footer id="footer">
    <div class="inner">
        <section>
            <h2>About</h2>
            <div>
                新一代轻量级PHP框架「<a href='http://easy-php.tigerb.cn'>EasyPHP</a>」作者，「<a href='http://skrshop.tech/'>《电商设计手册》</a>」作者，「<a href='https://github.com/TIGERB/easy-tips/tree/master/go/src/patterns'>《叼叼的设计模式》</a>」作者。拥有A/C轮创业、上市公司电商开发工作经验，现于小米集团从事后端开发工作。
            </div>
        </section>
        <section>
            <h2>Follow</h2>
            <ul class="icons">
                
                    <li><a href="https://twitter.com/CODERCOOKER" class="icon style2 fa-twitter" target="_blank" ><span class="label">Twitter</span></a></li>
                
                
                
                    <li><a href="https://www.instagram.com/codercooker/" class="icon style2 fa-instagram" target="_blank" ><span class="label">Instagram</span></a></li>
                
                
                
                    <li><a href="https://github.com/TIGERB" class="icon style2 fa-github" target="_blank" ><span class="label">GitHub</span></a></li>
                
                
                
                
                
                    <li><a href="mailto:tigerbcode@gmail.com" class="icon style2 fa-envelope-o" target="_blank" ><span class="label">Email</span></a></li>
                
                
                    <li><a href="\atom.xml" class="icon style2 fa-rss" target="_blank" ><span class="label">RSS</span></a></li>
                
            </ul>
        </section>
        <ul class="copyright">
            <li>&copy; TIGERB.cn All right reserved. 津ICP备17006784号-2</li>
            <li><a href="https://juejin.im/user/5855e82d1b69e6006c9278b4" target="_blank">juejin</a></li>
            <li><a href="https://segmentfault.com/u/tigerb" target="_blank">Segmentfault</a></li>
            <li><a href="http://skrshop.tech/">电商设计手册</a></li>
            <li><a href="https://dayutalk.cn/">大愚Talk</a></li>
        </ul>
    </div>
</footer>
    </div>

    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- skel -->
<script src="/js/skel.min.js"></script>

<!-- Custom Code -->
<script src="/js/util.js"></script>

<!--[if lte IE 8]>
<script src="/js/ie/respond.min.js"></script>
<![endif]-->

<!-- Custom Code -->
<script src="/js/main.js"></script>

<!-- Gallery -->
<script src="https://cdn.bootcss.com/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->


</body>

</html>